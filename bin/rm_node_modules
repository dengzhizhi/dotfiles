#!bash

if [ ! -d "./node_modules" ]; then
    echo "node_modules folder not fould"
    exit 1
fi

# Don't put tailing slash in settings
REMOVAL_FOLDER="/tmp/node_modules_removal"
BLANK_FOLDER="/tmp/blankfolder"

# Latest rsync executable location (>= 3.2.3 as in Jan 2022)
REMOVE_EXECUTABLE="/usr/local/Cellar/rsync/3.2.3/bin/rsync"
REMOVE_CMD="$REMOVE_EXECUTABLE -a --delete $BLANK_FOLDER/ $REMOVAL_FOLDER/"
# REMOVE_EXECUTABLE="rm"
# REMOVE_CMD="$REMOVE_EXECUTABLE -rf $REMOVAL_FOLDER/"
# A trick to exclude the grep process
REMOVE_PROCESS_PATTERN="$REMOVE_EXECUTABLE -[a] --delete $BLANK_FOLDER/ $REMOVAL_FOLDER/"
# REMOVE_PROCESS_PATTERN="$REMOVE_EXECUTABLE -[r]f $REMOVAL_FOLDER/"

CHECK_RUNNING=`ps -ef | grep "$REMOVE_PROCESS_PATTERN"`

REMOVE_CLAUSE="$REMOVE_CMD &&"

if [[ "$CHECK_RUNNING" == *"$REMOVE_CMD"* ]]; then
    REMOVE_CLAUSE=""
fi

if [ ! -d "$REMOVAL_FOLDER" ]; then
    mkdir -p "$REMOVAL_FOLDER"
fi
if [ ! -d "$BLANK_FOLDER" ]; then
    mkdir -p "$BLANK_FOLDER"
fi

TEMP_DUMPING_FOLDER="$REMOVAL_FOLDER/node_modules_$RANDOM"
mkdir -p "$TEMP_DUMPING_FOLDER"

CMD="mv node_modules $TEMP_DUMPING_FOLDER && $REMOVE_CLAUSE osascript -e 'display notification \"Node Modules Deleted\"' && say 'Node Modules Deleted' || say 'Node Modules not deleted. Something went wrong'"

echo $CMD

nohup bash -c "$CMD" >/dev/null 2>&1 &
